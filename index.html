<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Liszt Sonata in B minor</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { font-family: system-ui, sans-serif; }
  body { margin: 24px; }
  h1 { margin: 0 0 12px; }
  #status { padding: 8px 12px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:8px; margin: 8px 0 16px; }
  audio { width: 100%; margin-bottom: 16px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  th, td { padding: 6px 8px; border: 1px solid #e5e7eb; }
  td.clickable a { text-decoration: none; color: #0b5bd3; }
  td.clickable a:hover { text-decoration: underline; }
  tr.playing td { background: #fff7ed; }
  .hidden { display: none; }
</style>
</head>
<body>
  <h1>Liszt Sonata in B minor</h1>
  <div id="status">Loading cuesâ€¦</div>
  <audio id="player" controls preload="metadata">
  <source src="Liszt.flac" type="audio/flac">
  <source src="Liszt.m4a" type="audio/mp4">
  <source src="Liszt.mp3" type="audio/mpeg">
  Your browser does not support audio playback.
</audio>
  <table id="cue-table" style="display:none;">
    <thead id="table-head"></thead>
    <tbody id="table-body"></tbody>
  </table>

<script>
  const statusBox = document.getElementById('status');
  const table = document.getElementById('cue-table');
  const thead = document.getElementById('table-head');
  const tbody = document.getElementById('table-body');

  function setStatus(msg, isError=false) {
    statusBox.textContent = msg;
    statusBox.style.background = isError ? '#fef2f2' : '#f1f5f9';
    statusBox.style.borderColor = isError ? '#fecaca' : '#e2e8f0';
  }

  function seekTo(anchor) {
    const player = document.getElementById('player');
    const seconds = parseFloat(anchor.dataset.seconds);
    if (Number.isNaN(seconds)) return false;
    document.querySelectorAll('#cue-table tr').forEach(r => r.classList.remove('playing'));
    anchor.closest('tr')?.classList.add('playing');
    const go = () => { player.currentTime = seconds; player.play(); };
    (player.readyState < 1) ? player.addEventListener('loadedmetadata', go, {once:true}) : go();
    return false;
  }

  function buildTable(rows) {
    if (!rows.length) throw new Error('Spreadsheet is empty.');
    const header = rows[0];
    const body = rows.slice(1);

    // Build header (hide column A)
    let headHtml = '<tr>';
    header.forEach((h, i) => {
      if (i === 0) {
        headHtml += `<th class="hidden">${h ?? ''}</th>`;
      } else {
        headHtml += `<th>${h ?? ''}</th>`;
      }
    });
    headHtml += '</tr>';
    thead.innerHTML = headHtml;

    tbody.innerHTML = '';
    let rowCount = 0;
    for (const r of body) {
      if (!r || r.length < 2) continue;
      const secs = r[0]; // column A
      const label = r[1]; // column B
      if (secs === undefined || secs === '') continue;
      let html = '<tr>';
      // hidden col A
      html += `<td class="hidden">${secs}</td>`;
      // col B clickable
      html += `<td class="clickable"><a href="#" data-seconds="${secs}" onclick="return seekTo(this)">${label}</a></td>`;
      // rest
      for (let i = 2; i < r.length; i++) html += `<td>${r[i] ?? ''}</td>`;
      html += '</tr>';
      tbody.insertAdjacentHTML('beforeend', html);
      rowCount++;
    }
    if (rowCount === 0) throw new Error('No cue rows found. Ensure Column A has seconds and Column B has labels.');
    table.style.display = '';
    setStatus(`Loaded ${rowCount} cues.`);
  }

  async function tryLoadXLSX(path='Liszt.xlsx') {
    const res = await fetch(path);
    if (!res.ok) throw new Error(`${path} not found (HTTP ${res.status}).`);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });
    buildTable(rows);
  }

  (async function init() {
    try {
      await tryLoadXLSX('Liszt.xlsx');
    } catch (e) {
      console.error(e);
      setStatus('Could not load Liszt.xlsx. Make sure it is in the same folder as index.html. Column A = seconds, Column B = label.', true);
    }
  })();
</script>
</body>
</html>
