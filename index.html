<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Liszt Sonata – Cues from Excel</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { font-family: system-ui, sans-serif; }
  body { margin: 24px; }
  h1 { margin-bottom: 12px; }
  audio { width: 100%; margin-bottom: 16px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  th, td { padding: 6px 8px; border: 1px solid #ddd; }
  td.time a { text-decoration: none; color: #0b5bd3; font-variant-numeric: tabular-nums; }
  td.time a:hover { text-decoration: underline; }
  tr.playing td { background: #fff7ed; }
</style>
</head>
<body>
  <h1>Liszt Sonata in B minor — cues from <code>liszt.xlsx</code></h1>
  <audio id="player" src="Liszt.mp3" controls preload="metadata"></audio>
  <table id="cue-table">
    <thead id="table-head"></thead>
    <tbody id="table-body"></tbody>
  </table>

<script>
  // helper: format seconds → mm:ss
  function formatTime(secs) {
    secs = Math.floor(secs);
    const m = Math.floor(secs / 60);
    const s = secs % 60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  // when a timestamp is clicked
  function seekTo(anchor) {
    const player = document.getElementById('player');
    const seconds = parseFloat(anchor.dataset.seconds);
    if (isNaN(seconds)) return false;

    document.querySelectorAll('#cue-table tr').forEach(r => r.classList.remove('playing'));
    anchor.closest('tr').classList.add('playing');

    const doSeek = () => { player.currentTime = seconds; player.play(); };
    if (player.readyState < 1) {
      player.addEventListener('loadedmetadata', doSeek, { once: true });
      player.load();
    } else {
      doSeek();
    }
    return false;
  }

  // load and parse Excel
  fetch('liszt.xlsx')
    .then(res => res.arrayBuffer())
    .then(data => {
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // raw 2D array

      if (rows.length === 0) return;
      const headerRow = rows[0];
      const bodyRows = rows.slice(1);

      // build table header
      const thead = document.getElementById('table-head');
      let headHtml = '<tr>';
      headerRow.forEach(h => { headHtml += `<th>${h || ''}</th>`; });
      headHtml += '</tr>';
      thead.innerHTML = headHtml;

      // build table body
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      bodyRows.forEach(row => {
        if (row.length === 0) return;
        const secs = row[0]; // column A in seconds
        let tr = '<tr>';

        // column A → clickable time
        tr += `<td class="time"><a href="#" data-seconds="${secs}" onclick="return seekTo(this)">${formatTime(secs)}</a></td>`;

        // rest of columns
        for (let i=1; i<row.length; i++) {
          tr += `<td>${row[i] !== undefined ? row[i] : ''}</td>`;
        }
        tr += '</tr>';
        tbody.innerHTML += tr;
      });
    })
    .catch(err => console.error('Error loading liszt.xlsx:', err));
</script>
</body>
</html>
